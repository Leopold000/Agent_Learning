# Agent学习项目 - 智能RAG助手开发教程

本项目是一个从基础到进阶的Agent开发学习路径，涵盖了从简单的聊天机器人到智能RAG助手，再到具备工具调用能力的完整Agent系统的实现。

## 📁 项目结构

```
Agent_Learning/
├── 00_basic.js                    # 基础Ollama API调用
├── 01_chat.js                     # 简单聊天功能
├── 02_stream.js                   # 流式输出实现
├── 03_chat_stream.js              # 聊天+流式输出
├── 04_terminal_chat.js            # 终端聊天界面
├── 05_terminal_chat_ui.js         # 增强终端UI
├── 06_rag/                        # 基础RAG实现
├── 07_RAG_intellingent/           # 智能检索决策RAG
├── 08_RAG_tools/                  # Function Calling实现
├── 09_RAG_Tools/                  # 智能工具调用RAG (最新)
└── data/                          # 知识库数据
```

## 🚀 学习路径

### 阶段1：基础篇 (00-05)
- **00_basic.js**: 学习如何调用Ollama API
- **01_chat.js**: 实现基本的聊天功能
- **02_stream.js**: 学习流式输出技术
- **03_chat_stream.js**: 结合聊天和流式输出
- **04_terminal_chat.js**: 创建终端交互界面
- **05_terminal_chat_ui.js**: 增强终端UI体验

### 阶段2：RAG篇 (06-07)
- **06_rag/**: 基础RAG实现，向量检索+知识库
- **07_RAG_intellingent/**: 智能检索决策系统，解决"不是每次输入都需要检索知识库"的问题

### 阶段3：工具调用篇 (08-09)
- **08_RAG_tools/**: Function Calling实现，Agent可以调用外部工具
- **09_RAG_Tools/**: **智能工具调用RAG**，结合07的智能检索决策和08的工具调用功能

## 🎯 09_RAG_Tools - 智能工具调用RAG助手

这是本项目的最新版本，结合了07的智能检索决策系统和08的工具调用功能，实现了真正的智能Agent。

### 核心特性

1. **三层智能决策系统**
   - 工具调用优先：自动识别并调用合适的外部工具
   - 知识库检索：专业问题检索相关文档
   - 通用对话：简单问题直接回答

2. **丰富的工具集**
   - 计算工具：数学表达式计算
   - 转换工具：温度、长度、货币单位转换
   - 数据查询：用户、项目、任务、公司信息查询
   - 系统工具：服务器状态监控

3. **混合模式支持**
   - 规则模式：基于关键词的快速判断
   - LLM模式：基于大语言模型的精确意图分析

### 📂 09_RAG_Tools目录结构

```
09_RAG_Tools/
├── api_server.js          # Mock API服务器，提供工具调用接口
├── chat_rag.js           # 主Agent程序，智能RAG助手
├── tool_manager.js       # 工具管理模块（核心）
├── rag_search.js         # 知识库检索模块
├── test_tools.js         # 工具调用测试
├── quick_test.js         # 快速功能测试
└── test_agent.sh         # 完整测试脚本
```

### 🛠️ 核心模块详解

#### 1. **tool_manager.js** - 工具管理模块
这是智能工具调用的核心，包含以下功能：

- **工具定义**: 定义9种不同类型的工具
- **工具识别**: 基于关键词和模式匹配判断是否需要工具调用
- **工具选择**: 智能选择最适合的工具
- **参数提取**: 从用户查询中自动提取工具参数
- **工具执行**: 调用API服务器执行工具
- **结果格式化**: 将工具结果转换为易读格式

```javascript
// 工具类型定义
const ToolType = {
  CALCULATION: "calculation",      // 计算类工具
  CONVERSION: "conversion",        // 转换类工具
  DATA_QUERY: "data_query",        // 数据查询类工具
  SYSTEM: "system",                // 系统类工具
};

// 工具调用流程
用户查询 → 工具识别 → 工具选择 → 参数提取 → 工具执行 → 结果处理
```

#### 2. **chat_rag.js** - 主Agent程序
基于07的智能RAG助手扩展，新增工具调用功能：

- **扩展意图识别**: 增加了`shouldCallTool()`函数
- **优先级决策**: 工具调用 > 知识库检索 > 通用对话
- **结果集成**: 将工具调用结果作为上下文传递给LLM
- **混合模式**: 支持规则和LLM两种意图分析模式

#### 3. **api_server.js** - API服务器
提供RESTful API接口，支持以下功能：

- **用户管理**: `/api/users`, `/api/users/:id`
- **项目管理**: `/api/projects`, `/api/projects/:id`
- **任务管理**: `/api/tasks`
- **公司信息**: `/api/company`, `/api/company/metrics`
- **工具函数**: `/api/tools/calculate`, `/api/tools/convert`
- **系统状态**: `/api/system/status`

### 🚦 快速开始

#### 1. 启动API服务器
```bash
cd 09_RAG_Tools
node api_server.js
```

#### 2. 启动智能Agent
```bash
cd 09_RAG_Tools
node chat_rag.js
```

#### 3. 使用示例

```
✨ 智能RAG助手启动！
──────────────────────────────────────────────
🧠 特性：智能检索决策 + 多轮对话 + 流式输出 + 工具调用
📊 模式：混合（规则 + LLM意图分析）
🛠️ 支持工具：计算器、单位转换、数据查询、系统状态等
──────────────────────────────────────────────

💡 使用方法：
- 通用问题（问候、闲聊）：直接回答
- 专业问题（技术、规范）：检索知识库后回答
- 工具问题（计算、查询、转换）：自动调用工具
- 输入 'mode llm' 切换为LLM意图分析
- 输入 'mode rule' 切换为规则判断

🛠️ 工具调用示例：
  • 计算："2+3等于多少"，"计算sin(30)"
  • 转换："20摄氏度等于多少华氏度"，"100美元等于多少人民币"
  • 查询："有哪些用户"，"张三的信息"，"项目状态"
  • 系统："系统状态"，"内存使用情况"
──────────────────────────────────────────────
```

### 🔧 技术实现细节

#### 智能决策流程
```
用户问题
    ↓
shouldCallTool()判断
    ├── 需要工具调用 → intelligentToolCall() → 工具执行 → AI响应
    │
    ├── 需要知识库检索 → search() → 文档检索 → AI响应
    │
    └── 通用问题 → 直接AI响应
```

#### 工具选择算法
采用加权评分系统：
1. **名称匹配** (+5分): 工具名称出现在查询中
2. **关键词匹配** (+2分): 工具类型关键词匹配
3. **描述匹配** (+1分): 工具描述关键词匹配
4. **特殊规则** (+3分): 特定领域强化（如"公司"→公司相关工具）

#### 参数提取策略
- **正则表达式匹配**: 针对不同工具类型设计专门的正则模式
- **单位映射系统**: 支持中英文单位自动转换
- **智能推断**: 当参数不全时自动推断缺失参数

### 📊 测试验证

#### 工具调用测试
```bash
cd 09_RAG_Tools
node test_tools.js
```

#### 快速功能测试
```bash
cd 09_RAG_Tools
node quick_test.js
```

#### 完整Agent测试
```bash
cd 09_RAG_Tools
./test_agent.sh
```

### 🎨 设计亮点

1. **模块化设计**: 工具管理独立成模块，便于扩展
2. **错误处理**: 工具调用失败时自动回退到其他处理方式
3. **用户友好**: 清晰的日志输出和进度提示
4. **可扩展性**: 容易添加新的工具类型和API接口
5. **智能决策**: 三层决策系统确保最佳响应策略

### 🔮 未来扩展方向

1. **更多工具类型**: 文件操作、网络请求、数据库查询等
2. **工具链支持**: 多个工具组合调用
3. **动态工具注册**: 运行时添加新工具
4. **工具调用确认**: 用户确认后再执行敏感操作
5. **历史记录**: 工具调用历史和结果缓存
6. **权限控制**: 基于角色的工具访问控制

### 📚 技术栈

- **运行时**: Node.js
- **AI模型**: Ollama (llama3.1:8b)
- **向量数据库**: 本地向量存储
- **HTTP客户端**: Axios
- **框架**: LangChain.js
- **API框架**: Express.js

### 🏗️ 架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面      │    │   智能决策层     │    │   执行层        │
│   (终端)        │◄──►│   (chat_rag.js)  │◄──►│   (工具/检索)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                             │                         │
                             ▼                         ▼
                    ┌─────────────────┐    ┌─────────────────┐
                    │   工具管理层     │    │   API服务器     │
                    │ (tool_manager.js)│◄──►│ (api_server.js) │
                    └─────────────────┘    └─────────────────┘
```

## 📖 学习收获

通过这个项目，你可以学习到：

1. **Agent基础**: 如何构建一个基本的AI助手
2. **RAG技术**: 检索增强生成的实际应用
3. **工具调用**: Function Calling的实现原理
4. **智能决策**: 多层意图识别和优先级处理
5. **系统设计**: 模块化、可扩展的软件架构
6. **工程实践**: 错误处理、日志记录、测试验证

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进这个项目。建议的改进方向包括：

- 添加新的工具类型
- 优化工具选择算法
- 改进参数提取逻辑
- 增加测试覆盖率
- 完善文档说明

## 📄 许可证

本项目仅供学习和研究使用。

---

**开始你的Agent开发之旅吧！从基础到进阶，一步步构建强大的智能助手。** 🚀