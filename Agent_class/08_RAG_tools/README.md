# 🚀 08_RAG_tools - 智能RAG助手（Tools版）

基于07_RAG_intelligent版本，增加了**Tools/Function Calling**功能，使Agent能够调用外部API获取数据或执行操作。

## 📋 功能特性

### 1. 智能决策系统
- **通用问题**：问候、闲聊、简单询问 → 直接回答
- **知识问题**：技术、规范、文档 → RAG检索知识库
- **数据查询**：用户、项目、公司信息 → 调用工具API
- **计算转换**：数学计算、单位转换 → 调用工具API

### 2. 工具集（Tools/Function Calling）
- **用户管理**：查询用户信息、搜索员工
- **项目管理**：获取项目列表、查询项目状态
- **任务管理**：查看任务分配、按条件过滤
- **公司信息**：获取公司基本信息和指标
- **计算工具**：数学表达式计算
- **转换工具**：温度、长度、货币单位转换
- **系统状态**：检查API服务器状态

### 3. 技术架构
```
用户输入 → 智能决策 → 选择处理方式
                      ├── 通用对话 (直接回答)
                      ├── RAG检索 (知识库问答)
                      └── 工具调用 (API数据获取)
```

## 🚀 快速开始

### 方案1：使用传统智能RAG助手

#### 步骤1：启动API服务器
```bash
# 在08_RAG_tools目录下
node api_server.js
```
输出：
```
🚀 Mock API服务器启动成功！
📡 地址: http://localhost:3000
📋 可用端点: ...
```

#### 步骤2：启动智能RAG助手
```bash
# 在另一个终端窗口
node chat_rag_tools.js
```

#### 步骤3：开始交互
```
✨ 智能RAG助手（Tools版）启动！
──────────────────────────────────────────────
🧠 特性：智能检索决策 + 工具调用 + 多轮对话 + 流式输出
🛠️  可用工具：用户查询、项目管理、公司信息、计算转换等
──────────────────────────────────────────────
🔄 检查API服务器状态...
✅ API服务器可用 (healthy)
正在加载知识库...
✅ 知识库加载成功

💡 使用方法：
- 通用问题（问候、闲聊）：直接回答
- 知识问题（技术、规范）：检索知识库后回答
- 数据查询（用户、项目、公司）：调用工具获取信息
- 计算转换：调用计算和单位转换工具
- 输入 'clear' 重置对话记忆
- 输入 'tools' 查看可用工具
- 输入 'exit' 退出
──────────────────────────────────────────────
🧑 你：
```

### 方案2：使用基于Langchain createAgent的新智能助手

#### 步骤1：启动API服务器
```bash
# 在08_RAG_tools目录下
node api_server.js
```

#### 步骤2：运行智能助手
```bash
# 构建知识库（如果尚未构建）
# node embed.js

# 运行智能助手（交互模式）
npm run smart-agent

# 或者运行功能测试
npm run test-smart-agent

# 或者运行多轮对话演示
npm run demo-conversation
```

## 🎯 使用示例

### 示例1：通用问题
```
🧑 你：你好
🤔 分析问题意图...
📊 分析结果: general类型
✅ 判断为通用问题，直接回答
──────────────────────────────────────────────
🤖 AI：你好！我是你的智能助手，有什么可以帮助你的吗？
```

### 示例2：知识库问题
```
🧑 你：代码规范有哪些要求？
🤔 分析问题意图...
📊 分析结果: knowledge类型
🔍 判断为知识库问题，开始检索...
✅ 检索完成，找到 3 个相关文档
──────────────────────────────────────────────
🔍 检索结果：
【1】《公司内部开发流程规范（节选）》...
【2】一个示例：自定义加法函数...
【3】LangChain.js 知识库构建笔记...
──────────────────────────────────────────────
🤖 AI：根据检索到的知识库内容，代码规范主要包括...
```

### 示例3：工具调用（用户查询）
```
🧑 你：公司有哪些员工？
🤔 分析问题意图...
📊 分析结果: tools类型
🛠️  可能需要工具: users
──────────────────────────────────────────────
🤖 AI：我来帮你查询公司员工信息...
🔧 进入工具调用模式...
🛠️  检测到工具调用: get_users
📋 参数: {}
✅ 工具执行成功: 获取所有用户列表
📊 结果概要:
   数量: 4
   示例: {"id":1,"name":"张三","role":"开发工程师"...}

🤖 AI总结：公司目前有4名员工，包括开发工程师张三...
```

### 示例4：工具调用（计算）
```
🧑 你：计算一下2+3*4
🤔 分析问题意图...
📊 分析结果: tools类型
🛠️  可能需要工具: calculations
──────────────────────────────────────────────
🤖 AI：我来帮你计算这个表达式...
🔧 进入工具调用模式...
🛠️  检测到工具调用: calculate
📋 参数: {"expression":"2+3*4"}
✅ 工具执行成功: 计算表达式: 2+3*4
📊 结果概要:
   数据: {"expression":"2+3*4","result":14,"type":"number"}

🤖 AI总结：2+3*4的计算结果是14。
```

## 📁 文件说明

### 核心文件
1. **`api_server.js`** - Mock API后端服务器
   - 提供模拟数据API
   - 运行在 http://localhost:3000
   - 包含用户、项目、任务、公司信息等端点

2. **`tools_client.js`** - 工具客户端
   - 定义所有可用的tools功能
   - 提供工具执行器
   - 处理API调用和结果解析

3. **`chat_rag_tools.js`** - 主程序
   - 整合RAG、智能决策和tools功能
   - 智能判断问题类型
   - 处理工具调用和结果展示

4. **`rag_search.js`** - 知识库搜索
   - 从07版本复制
   - 向量数据库连接和检索

5. **`smart_agent.js`** - 基于Langchain createAgent的智能助手
   - 使用LLM进行语义理解
   - 集成Langchain的createAgent实现智能工具调用
   - 支持自然语言工具调用

6. **`lib/`** - 模块化代码目录
   - `agent.js` - 智能助手核心实现
   - `tools.js` - 工具定义
   - `init.js` - 初始化模块
   - `main.js` - 主模块

### 辅助文件
- **`test_tools.js`** - 功能测试脚本
- **`README.md`** - 本文档
- **`run_smart_agent.js`** - 智能助手运行脚本

## 🔧 技术细节

### 智能决策逻辑
```javascript
// 1. 关键词匹配
const TOOLS_KEYWORDS = {
  users: ["用户", "员工", "同事", "成员"],
  projects: ["项目", "工程", "任务"],
  company: ["公司", "企业", "组织"],
  calculations: ["计算", "算", "等于"],
  conversions: ["转换", "换算", "温度"],
};

// 2. 决策流程
function analyzeQuestionType(query) {
  if (containsToolKeywords(query)) return 'tools';
  if (containsKnowledgeKeywords(query)) return 'knowledge';
  return 'general';
}
```

### 工具调用流程
1. **意图识别**：判断是否需要工具
2. **工具选择**：匹配最合适的工具
3. **参数提取**：从问题中提取工具参数
4. **API调用**：执行工具函数
5. **结果处理**：格式化并展示结果
6. **总结生成**：基于结果生成自然语言回答

### API端点
```
GET /api/users          # 用户列表
GET /api/projects       # 项目列表
GET /api/tasks          # 任务列表
GET /api/company        # 公司信息
GET /api/tools/calculate # 计算工具
GET /api/tools/convert  # 单位转换
GET /api/system/status  # 系统状态
GET /health            # 健康检查
```

## 🚨 注意事项

### 1. 依赖要求
- Node.js环境
- Ollama服务运行中（用于LLM）
- 知识库已构建（运行过embed.js）

### 2. 启动顺序
```bash
# 1. 确保Ollama服务运行
ollama serve

# 2. 启动API服务器（终端1）
node api_server.js

# 3. 启动RAG助手（终端2）
node chat_rag_tools.js
```

### 3. 故障排除
- **API服务器不可用**：检查端口3000是否被占用
- **知识库加载失败**：运行 `node embed.js` 构建知识库
- **Ollama连接失败**：确保 `ollama serve` 正在运行

## 🎉 版本亮点

### 相较于07版本的改进
1. **新增Tools功能**：支持function calling调用外部API
2. **扩展决策逻辑**：除了RAG决策，新增工具调用决策
3. **丰富数据源**：通过Mock API提供多样化数据
4. **实用工具集**：计算、转换、查询等实用功能
5. **完整工作流**：意图识别→工具调用→结果处理→总结生成

### 应用场景
- **企业内部助手**：查询员工、项目信息
- **技术知识库**：代码规范、开发文档检索
- **数据查询工具**：公司指标、任务状态查询
- **计算助手**：数学计算、单位转换

## 📚 下一步

### 可能的扩展
1. **更多工具**：添加天气查询、新闻获取等工具
2. **工具链**：支持多个工具串联调用
3. **权限控制**：基于用户角色的工具访问控制
4. **工具学习**：基于使用历史优化工具选择
5. **可视化界面**：Web界面展示工具调用过程

### 优化方向
1. **参数解析**：更智能的参数提取
2. **错误处理**：更完善的工具调用容错
3. **性能优化**：缓存常用工具结果
4. **用户体验**：更自然的工具调用交互

---

💡 **现在你的RAG助手不仅能检索知识库，还能调用工具获取实时数据和执行操作了！**