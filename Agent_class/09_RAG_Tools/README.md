# 09_RAG_Tools - 智能工具调用RAG助手

这是Agent学习项目的最新版本，结合了**07的智能检索决策系统**和**08的工具调用功能**，实现了真正的智能Agent，能够自动判断何时需要调用工具、何时需要检索知识库、何时可以直接回答。

## 🎯 核心特性

### 1. 三层智能决策系统
- **工具调用优先**: 自动识别用户问题是否需要调用外部工具
- **知识库检索**: 专业问题自动检索相关文档
- **通用对话**: 简单问题直接由LLM回答

### 2. 丰富的工具集
- **计算工具**: 数学表达式计算 (加减乘除、函数等)
- **转换工具**: 温度、长度、货币单位转换
- **数据查询**: 用户、项目、任务、公司信息查询
- **系统工具**: 服务器状态监控

### 3. 混合模式支持
- **规则模式**: 基于关键词的快速判断（默认）
- **LLM模式**: 基于大语言模型的精确意图分析

## 📁 模块化文件结构 (v2.0)

### 核心模块
```
09_RAG_Tools/
├── chat_rag.js           # 主程序入口 - 协调各模块工作
├── api_server.js         # Mock API服务器 - 提供工具调用接口
├── tool_manager.js       # 工具管理模块 - 工具选择、参数提取、执行
├── intent_detector.js    # 意图识别模块 - 判断是否需要工具/检索
├── chat_system.js        # 对话系统模块 - prompt模板、chain、记忆管理
├── utils.js              # 工具函数模块 - 颜色输出、readline、格式化
└── rag_search.js         # 知识库检索模块 - 向量搜索功能
```

### 测试和工具文件
```
09_RAG_Tools/
├── test_modular.js       # 模块化版本测试 - 验证各模块功能
├── test_tools.js         # 工具调用测试 - 完整工具调用测试
├── quick_test.js         # 快速功能测试 - 核心功能验证
├── test_agent.sh         # 完整测试脚本 - 启动API+Agent测试
├── chat_rag_monolithic.js # 原始单体版本备份 (600+行)
└── chat_rag_original.js  # 07版本备份 - 历史参考
```

## 🚀 快速开始

### 步骤1: 启动API服务器
```bash
cd 09_RAG_Tools
node api_server.js
```

输出示例：
```
🚀 Mock API服务器启动成功！
📡 地址: http://localhost:3000
📋 可用端点:
  - GET /              : 服务器信息
  - GET /health        : 健康检查
  - GET /api/users     : 用户列表
  - GET /api/projects  : 项目列表
  - GET /api/tasks     : 任务列表
  - GET /api/company   : 公司信息
  - GET /api/tools/*   : 工具函数
  - GET /api/system/status : 系统状态
```

### 步骤2: 启动智能Agent
```bash
cd 09_RAG_Tools
node chat_rag.js
```

### 步骤3: 开始交互
Agent启动后会显示使用说明，你可以尝试以下类型的查询：

## 🛠️ 使用示例

### 计算类问题
```
🧑 你：2+3等于多少
🤔 分析问题意图...
🔧 当前模式: 规则模式
🔧 用户问题: 2+3等于多少
🔧 检测到工具关键词: "等于" - 可能需要calculation工具
🛠️ 判断为工具调用问题，准备调用工具...

🤖 分析是否需要工具调用...
🔧 检测到工具关键词: "等于" - 可能需要calculation工具
🔧 匹配到 2 个可能工具
🔧 选择工具: calculate (执行数学表达式计算，支持加减乘除、指数、函数等)
📝 提取参数: {"expression":"2+3"}
🛠️ 执行工具: calculate
🔧 参数: {"expression":"2+3"}
🔗 请求URL: http://localhost:3000/api/tools/calculate?expression=2%2B3
✅ 工具执行成功

🤖 AI：
🛠️ 工具调用结果：
计算结果：2+3 = 5
```

### 转换类问题
```
🧑 你：20摄氏度等于多少华氏度
🤔 分析问题意图...
🔧 当前模式: 规则模式
🔧 用户问题: 20摄氏度等于多少华氏度
🔧 检测到工具关键词: "等于" - 可能需要calculation工具
🛠️ 判断为工具调用问题，准备调用工具...

🤖 分析是否需要工具调用...
🔧 检测到工具关键词: "等于" - 可能需要calculation工具
🔧 匹配到 2 个可能工具
🔍 匹配结果:
  1. convert (单位转换工具，支持温度、长度、货币等单位的转换) - 分数: 6
  2. calculate (执行数学表达式计算，支持加减乘除、指数、函数等) - 分数: 2
🔧 选择工具: convert (单位转换工具，支持温度、长度、货币等单位的转换)
📝 提取参数: {"value":20,"from":"celsius","to":"fahrenheit"}
🛠️ 执行工具: convert
🔧 参数: {"value":20,"from":"celsius","to":"fahrenheit"}
🔗 请求URL: http://localhost:3000/api/tools/convert?value=20&from=celsius&to=fahrenheit
✅ 工具执行成功

🤖 AI：
🛠️ 工具调用结果：
转换结果：20 celsius = 68.00 fahrenheit
```

### 数据查询类问题
```
🧑 你：公司信息
🤔 分析问题意图...
🔧 当前模式: 规则模式
🔧 用户问题: 公司信息
🔧 检测到工具关键词: "公司" - 可能需要data_query工具
🛠️ 判断为工具调用问题，准备调用工具...

🤖 分析是否需要工具调用...
🔧 检测到工具关键词: "公司" - 可能需要data_query工具
🔧 匹配到 6 个可能工具
🔍 匹配结果:
  1. get_company_info (获取公司基本信息) - 分数: 7
  2. get_company_metrics (获取公司运营指标) - 分数: 7
  3. get_users (获取用户列表，可以按名称搜索用户) - 分数: 4
🔧 选择工具: get_company_info (获取公司基本信息)
📝 提取参数: {}
🛠️ 执行工具: get_company_info
🔧 参数: {}
🔗 请求URL: http://localhost:3000/api/company
✅ 工具执行成功

🤖 AI：
🛠️ 工具调用结果：
公司信息：创新科技公司
成立时间：2018年
员工数：150
部门：技术部, 产品部, 设计部, 市场部, 行政部
```

## 🔧 核心模块详解 (模块化版本)

### 1. tool_manager.js - 工具管理模块
**职责**: 工具定义、选择、参数提取、执行、结果格式化

#### 工具定义
定义了9种工具，分为4个类别：
- **计算类**: `calculate` - 数学表达式计算
- **转换类**: `convert` - 单位转换
- **数据查询类**: `get_users`, `get_projects`, `get_tasks`, `get_company_info`, `get_company_metrics`
- **系统类**: `get_system_status`

#### 核心算法
- **加权评分系统**: 智能选择最合适的工具
- **正则表达式匹配**: 精准提取工具参数
- **单位映射系统**: 支持中英文单位自动转换

### 2. intent_detector.js - 意图识别模块
**职责**: 判断用户问题类型，决定处理策略

#### 三层决策系统
1. **工具调用判断**: 检测关键词，调用`shouldUseTool()`深度判断
2. **知识库检索判断**: 基于关键词和问题结构判断
3. **通用对话判断**: 简单问题直接回答

#### 混合模式
- **规则模式**: 基于关键词的快速判断（默认）
- **LLM模式**: 使用大模型进行精确意图分析

### 3. chat_system.js - 对话系统模块
**职责**: 对话链创建、记忆管理、响应生成

#### 核心功能
- **Prompt模板**: 通用对话和RAG对话两种模板
- **对话链管理**: 创建和管理LangChain对话链
- **记忆管理**: Session级别的对话历史存储
- **响应生成**: 流式输出AI响应

### 4. utils.js - 工具函数模块
**职责**: 提供通用的工具函数

#### 功能分类
- **颜色输出**: 彩色终端输出，增强可读性
- **Readline工具**: 终端交互接口管理
- **格式化工具**: 文本截断、列表格式化等
- **通用函数**: sleep、错误处理等

### 5. chat_rag.js - 主程序入口
**职责**: 协调各模块工作，处理用户交互

#### 核心逻辑
- **主循环**: 持续接收用户输入
- **命令处理**: 系统命令和模式切换
- **模块协调**: 调用各模块完成完整流程
- **错误处理**: 统一的错误处理和优雅退出

### 6. api_server.js - API服务器
**职责**: 提供RESTful API接口供工具调用

#### 接口分类
- 6个主要API类别
- 12个具体端点
- 支持查询参数过滤
- 返回模拟数据

## 📊 测试验证

### 模块化测试
```bash
# 测试各模块功能
node test_modular.js

# 测试工具调用
node test_tools.js

# 快速功能测试
node quick_test.js

# 完整Agent测试 (需要先启动API服务器)
./test_agent.sh
```

### 测试内容
1. **模块功能测试** (`test_modular.js`):
   - 意图识别准确性
   - 智能检索决策
   - 对话系统创建
   - 各模块集成

2. **工具调用测试** (`test_tools.js`):
   - 计算类：`2+3等于多少`、`计算sin(30)`、`10*5+2等于多少`
   - 转换类：`20摄氏度等于多少华氏度`、`100美元等于多少人民币`、`5米等于多少英尺`
   - 数据查询：`有哪些用户`、`张三的信息`、`项目列表`、`任务列表`、`公司信息`
   - 系统类：`系统状态`
   - 通用问题：`你好`、`今天天气怎么样`

3. **完整流程测试** (`test_agent.sh`):
   - 启动API服务器
   - 启动智能Agent
   - 交互式功能测试

## 🎨 设计亮点

### 1. 模块化架构优势
- **清晰职责分离**: 6个模块各司其职，代码结构清晰
- **易于维护扩展**: 修改特定功能只需关注对应模块
- **独立测试验证**: 每个模块都可以单独测试
- **代码复用性强**: 模块可以在其他Agent项目中重用
- **团队协作友好**: 多人可以并行开发不同模块

### 2. 智能决策流程 (模块化版本)
```
用户输入 → chat_rag.js (主控)
    ↓
intent_detector.js (意图分析)
    ├── 需要工具调用 → tool_manager.js → api_server.js → chat_system.js
    ├── 需要知识库检索 → rag_search.js → chat_system.js
    └── 通用问题 → chat_system.js
```

### 3. 错误处理机制
- **分层回退**: 工具调用失败 → 知识库检索 → 通用对话
- **模块隔离**: 单个模块错误不影响整体系统
- **明确提示**: 详细的错误信息和恢复建议
- **优雅退出**: 统一的错误处理和进程管理

### 4. 用户体验优化
- **彩色输出**: 模块化的颜色工具，清晰区分不同阶段
- **进度提示**: 实时显示处理状态，用户了解进度
- **调试友好**: 详细的日志信息，便于问题排查
- **交互自然**: 流式输出，接近真人对话体验

## 🔮 扩展指南

### 添加新工具
1. 在`tool_manager.js`的`TOOLS`数组中添加新工具定义
2. 在`TOOL_KEYWORDS`中添加相关关键词
3. 在`extractToolParameters`函数中添加参数提取逻辑
4. 在`formatToolResult`函数中添加结果格式化逻辑

### 示例：添加天气查询工具
```javascript
// 1. 添加工具定义
{
  name: "get_weather",
  type: ToolType.DATA_QUERY,
  description: "查询城市天气信息",
  parameters: {
    city: {
      type: "string",
      description: "城市名称",
      required: true
    }
  },
  endpoint: "/api/weather",
  method: "GET"
}

// 2. 添加关键词
const TOOL_KEYWORDS = {
  // ... 现有关键词
  data_query: ["用户", "员工", "项目", "任务", "公司", "部门", "信息", "列表", "查询", "查找", "搜索", "天气"], // 新增"天气"
};

// 3. 在api_server.js中添加对应API
app.get('/api/weather', (req, res) => {
  const { city } = req.query;
  // ... 实现天气查询逻辑
});
```

### 性能优化建议
1. **缓存工具调用结果**: 对相同查询缓存结果
2. **并行处理**: 工具调用和知识库检索可以并行执行
3. **预处理**: 对常用工具参数进行预处理
4. **批量请求**: 支持多个工具批量调用

## 🚨 注意事项

1. **API服务器必须运行**: 工具调用需要API服务器支持
2. **Ollama服务**: 需要本地运行Ollama服务
3. **知识库构建**: 首次运行需要构建知识库向量索引
4. **计算安全**: API服务器的`eval`使用仅用于演示，生产环境需要更安全方案

## 📚 相关资源

- [07版本文档](../07_RAG_intellingent/): 智能检索决策系统

## 📈 版本演进

### v1.0 (初始版本)
- 单体文件，约600行代码
- 功能完整但代码结构复杂
- 所有逻辑混合在一个文件中

### v2.0 (模块化版本) ✅ 当前版本
- **6个清晰模块**，职责分离
- **~660行总代码**，但结构清晰
- **易于维护和扩展**
- **支持独立测试**
- **代码复用性高**

### 主要改进
1. **模块化拆分**: 从1个文件拆分为6个模块
2. **职责清晰**: 每个模块功能明确
3. **易于测试**: 新增
4. **可维护性**: 修改功能只需关注特定模块
5. **团队协作**: 多人可以并行开发

3. **易于测试**: 新增\模块测试
4. **可维护性**: 修改功能只需关注特定模块
5. **团队协作**: 多人可以并行开发不同模块

---

**现在开始体验模块化的智能RAG助手吧！代码更清晰，功能更强大，扩展更灵活。** 🚀
